# 计算机视觉

## 一、 简介

吹水

## 二、 滤波器filter和卷积convolution

爬了，这一章可以说是把以前学过的数字图像处理的基础知识简单过了一遍，建议看[数字图像处理的笔记](https://github.com/ender507/Lesson-Notes/blob/master/数字图像处理.md)的相关内容或者不看

### 2.1 色彩

当我们看到物体或光时，我们的视觉体验是心理属性（视觉神经感受），而不是这些物体或光的物理属性。

- RGB空间
  - 优点：适合于显示系统，直观且容易理解
  - 缺点：不符合人的视觉特性，三个颜色分量高度相关、均匀性较差  
- HSV（HSI）色调、饱和度、明度空间
  - 是根据颜色的直观特性创建的一种颜色空间, 也称六角锥体模型 
  - RGB方块在它的顶点处
- 伽马空间：将自然光以接近人眼感知能力曲线的函数压缩到 8 位图像：$V_{out}=V_{in}^\gamma$

### 2.2 图片采样与量化

数字图像是不连续的样本的拼接。图像由一定大小和密度的离散像素组成。DPI：一种采样参数，定义为每英寸的点数(DPI)或空间像素密度的等效度量

### 2.3 图像直方图

图像的直方图提供了图像中亮度(强度)值的频率。直方图能帮助我们检测图像中的特定特征。

### 2.4 将图像看做函数

图像通常是数字的(离散的)，是二维空间上的规则网格，用整数值矩阵表示。如此一来，二维的图片可以看做是一个二维函数$f(x,y)$，通过像素坐标给出了某个像素点的强度。与任何函数一样，我们可以对图像应用运算符。

### 2.5 图像滤波

滤波形成一个新的图像，其像素是原始像素的组合。与点操作的一个像素生成另一个像素不同的是，滤波通常用一个像素与其领域生成一个新的像素。

线性移不变图像滤波：用相邻像素(也可能包含它自己)的线性组合替换每个像素。这种组合是由滤波器的内核决定的。同一个内核被移动到所有像素位置，以便所有像素使用它们的邻居的相同的线性组合。

### 2.6 卷积convolution和相关correlation

emmm

--------

## 三、 边缘检测

### 3.1 边缘检测

目标：识别图像中的突然变化(不连续)的部分，即边缘。直观上来说，图像的大部分语义和形状信息都可以在边缘进行编码。边缘比像素更紧凑。

### 3.2 图像梯度

一维离散导数：

- 向后backward：$f'(x)=f(x)-f(x-1)$
- 向前forward：$f'(x)=f(x)-f(x+1)$
- 中心central：$f'(x)=f(x+1)-f(x-1)$

都可以写成滤波器的形式。

对于二维离散情况，可以分别求出两个方向的偏导数$f_x$和$f_y$，那么梯度大小为$|\nabla f(x,y)|=\sqrt{(f_x^2+f)_y^2}$，梯度方向为$\theta=\arctan\frac{f_x}{f_y}$，边缘方向与梯度方向垂直，将x和y换过来即可。

### 3.3 一个简单的边缘检测器

对于灰度图来说，边缘是图像强度函数快速变化的地方。由上面的一阶梯度就能求图像各个位置的梯度大小和方向。即使用有限差分滤波器。然而这样噪声会有很大的影响，所以考虑提前平滑图像，如平均平滑、高斯平滑等。而平滑过程可以看做是对原图像进行卷积，依据卷积的性质，对两个图像卷积后求梯度，等于对平滑滤波器求梯度后再与原图像进行卷积。

平滑的导数去除噪声，但也会模糊边缘。“最优”边缘检测器的准则：

- 检测特性：必须将假阳性(检测由噪声引起的伪边缘)和假阴性(丢失真实边缘)的概率降到最低。
- 定位特性：检测到的边缘必须尽可能接近真实边缘（不要歪七扭八）
- 单响应：检测器必须对每个真边缘点只返回一个点，最小化真实边缘附近的局部最大值的数目（类似于像素画中描边像素过多的“脏像素点”）

### 3.4 Sobel边缘检测

Sobel算子使用两个3×3核与原始图像卷积来计算导数的近似，一个用于水平，一个用于垂直：
$$
G_x=\left\{\begin{array}{}1 & 0 & -1\\2 & 0 & -2\\1 & 0 & -1\\\end{array}\right\}
$$

$$
G_y=\left\{\begin{array}{}1 & 2 & 1\\0 & 0 & 0\\-1 & -2 & -1\\\end{array}\right\}
$$

以$G_x$为例，可以拆分成：
$$
G_x=\left\{\begin{array}{}1 & 0 & -1\\2 & 0 & -2\\1 & 0 & -1\\\end{array}\right\}=[1\quad2\quad1]^T[1\quad0\quad-1]
$$
拆分成的前一个向量可以看做是进行高斯平滑的算子，后一个向量可以看做是计算梯度的算子。

Sobel算子的问题：

- 定位不佳(多个相邻像素的触发响应)
- 阈值倾向于某些方向：斜边多水平和竖直的边，且容易产生假阴性

### 3.5 Canny边缘检测

首先用高斯平滑，求每个像素的梯度方向和大小，然后应用非最大抑制确保最小响应：

为了找到边缘点，我们需要找到梯度大小的局部最大值；抑制非最大梯度，即使它大于梯度阈值。对于八个角度的方向，在每个方向上抑制所有不是最大值的像素；在每个标记的像素的邻域都这样做。说人话就是把多像素构成的脏边缘清理干净。

用$|\nabla G|(x,y)$表示在该点的梯度，则：
$$
M(x,y)=\left\{\begin{array}.|\nabla G|(x,y),|\nabla G|(x,y)>|\nabla G|(x',y')\and|\nabla G|(x,y)>|\nabla G|(x'',y'')\\0,otherwise\end{array}\right.
$$
换句话说，在水平、竖直、斜方向上，保留在邻域上的该方向上梯度大小最大的点。比如水平方向，上面的$(x',y')=(x-1,y)$，$(x'',y'')=(x+1,y)$。斜方向的相邻位置的不会正好落在像素点上，其梯度方向和大小用差值方法求。

通过上面的非最大抑制，可以让边缘更加干净。然后，使用迟滞和连通性分析来检测边缘：

通过滞后阈值防止某些检测出来的边缘点离群，构不成边缘。设置一个阈值上限和一个阈值下限。如果梯度小于下限则不是边缘，高于上限则是强边缘，否则为弱边缘。迭代地考虑每个弱边缘的邻居。如果能够与强边缘相连，则认为该弱边缘也是边缘，否则不是边缘。可以理解为用高阈值产生边缘曲线，用低阈值连通这些分离的边缘曲线。

高斯平滑的$\sigma$越大，则检测的边缘越强，越小则检测越多细节。

### 3.6 高斯平滑的拉普拉斯算子

边缘点可以通过求二阶导数的零点来检测：
$$
f''(x)=f(x+1)+f(x-1)-2f(x)
$$
有两种方法用二阶导数来识别边缘：

- 先平滑后求梯度
- 将平滑和求梯度合并

考虑到在离散情况下，不能总是找到零点，所以考虑零点可能存在的位置。相邻两个像素的二阶导一正一负，或是相邻三个像素两端一正一负，中间为0就是我们要找的点。如果相邻两个像素的二阶导分别为a和-b，则认为该处的边缘斜率为|a+b|。为了检测强零点，斜率要设置阈值。

求离散图片的二阶导一般用拉普拉斯算子。实现简单，具有各向同性，但不提供边缘方向的信息且对噪声相当敏感（因为是二阶导）。为了减少噪声干扰，需要先平滑。考虑使用高斯平滑，则该边缘检测被称为LoG边缘检测器。二维LoG卷积可以由4个一维卷积实现。总的算法如下：

- 计算LoG：高斯平滑滤波器求二阶导后与原图进行卷积
- 找每一行和每一列的零点
- 算出每个零点的斜率
- 用阈值筛选斜率并标记边缘

--------

## 四-一、 Hough霍夫变换HT

HT用于检测直线。霍夫变换也可以检测线，圆和其他结构，只要这些图形的参数方程是已知的。该算法能在噪声和部分遮挡条件下进行鲁棒检测。边不一定要连在一起，直线可以被阻挡。霍夫变换的关键思想在于不同的边缘对可能存在的直线进行投票，并选出票数高的直线。

将检测出的图像边缘点转换到参数空间：
$$
x\cos\theta+y\sin\theta=\rho
$$
原来的点为$x-y$空间的$(x,y)$，通过上述方程，对于一个确定的点$(x,y)$，在$\theta-\rho$空间可以表示为一条波形，而在$x-y$空间的一条直线会在$\theta-\rho$空间变成一个点。过定点的直线在参数空间可以看做在一条特定波形上移动的点。这样一来，就可以将边缘点都转换到参数空间，形成很多条波形。把这些波形经过的点都投票+1。最终在局部拥有最高票数的点转换回直角坐标空间，就得到了边缘直线。

在实践中，不可避免的有噪声，从而导致正确位置票数低，错误位置票数高。

霍夫变换还可以检测其他形状，如圆。如果半径已知，参数方程设为：
$$
(x-a)^2+(y-b)^2=r^2
$$
对于一个点$(x,y)$，在$a-b$空间中对应着一个圆。多个圆产生交点，交点就对应着直角坐标空间中的圆心位置。

总的来说，霍夫变换能够有效处理遮挡，能同时检测多个实例，对噪声也有一定的鲁棒性，但计算复杂度较高。

-------

## 四-二、 特征和拟合

### 4.1 直线检测的拟合方法模型

许多以直线为特征的物体，需要进行直线检测。而直线拟合相当困难。如何连点成线、如何检测缺失部分、如何处理噪声都是难题。通过将一个模型拟合到每个可能的子集来检查所有的特征组合是不可行的。

如果现在给出一组点，如何找到最佳拟合的直线呢？考虑让不同的模型进行投票，选择票数高的。我们不希望收到无关噪声“外点”的干扰，因此考虑只使用“内点”进行拟合。

随机抽样一致性RANSAC（不一定用于直线）：

1. 随机选择一组种子点
2. 只用种子点计算变换（如用最小二乘法计算直线）
3. 找到这个转换的内点（如找到非常接近该直线的点作为内点）
4. 如果内点的数量足够大，重新计算所有内点的最小二乘变换估计，保证每次变换都有最多的内点

需要注意的是，重新计算变换的时候可能会导致新的离群点的产生，甚至使得内点数量减少。

RANSAC方法评价：

- 通用方法适用于广泛的模型拟合问题
- 其实现简单，故障率也易于计算
- 只处理中等比例的异常值而不增加成本
- 许多实际问题都有很高的异常值率(但有时有选择地随机选择子集会有所帮助)

### 4.2 局部不变特征

处理图像匹配问题，比较两个或者多个图像，考虑使用局部特征。动机：

- 全局表示有很大的局限性
- 提高遮挡、不清晰等情况下的鲁棒性

块匹配patch matching：需要匹配的元素是固定大小的图像块。为了图像块能够相互区别，至少要有两次的梯度变换。

兴趣点（关键点）：局部特征与多个属性同时发生的图像属性的显著变化相关联(例如强度，颜色，纹理)。图像之间的对应点(或特征)可以用来估计描述图像之间几何变换的参数。如果不知道各个点之间的关系，则需要比较兴趣点周围局部块的特征描述符。

优良特征的性质：

- 局部性：对遮挡和杂波有鲁棒性
- 准确性：准确定位
- 不变性：可重复
- 独特性：个体特征可以与一个大型对象数据库相匹配
- 高效性：接近实时性能

如果一个函数f经过变化T仍然不变则称它是在变化T下不变的：
$$
f(x)=y\quad f(T(x))=y
$$
如果一个函数f满足以下性质则它是协变的：
$$
f(x)=y\quad f(T(x))=T(f(x))=T(y)
$$
对于不变性特征，尽管图像中有几何或光度变化，仍可以检测特征。给定同一图像的两个变换版本，在相应的位置检测特征。

角点：直观地说，是轮廓的结点。相对于视点的变化来说，更稳定的特征在所有方向上都有较大的变化。它们是很好的特征匹配。图像梯度有两个或两个以上的主导方向靠近角落，在任何方向移动一个窗口都应该在强度上有很大的变化。例如L型结、Y型结、T型结、箭头型结和X型结的角点。角点的主要检测步骤：

1. 对于输入图像中的每个像素，应用角点算子，得到该像素的角点测度。
2. 加入阈值，以消除薄弱角
3. 采用非最大抑制，消除某一距离内拐角测度不大于所有点拐角值的点。

### 4.3 关键点定位

哈里斯检测器：位移$[u,v]$的强度变化：
$$
E(u,v)=\sum_{x,y}w(x,y)[I(x+u,y+v)-I(x,y)]^2
$$
其中w为窗口函数，两个I的前一个为位移后的强度，后一个为位移前的强度。$E(u,v)$很大的区域表明这里的强度变化大。

2维函数的泰勒展开：
$$
f(x+u,y+v)\approx f(x,y)+uf_x(x,y)+vf_y(x,y)
$$
对于一个很小的位移，有：
$$
E(u,v)\approx [u,v]M[u,v]^T
$$
其中：
$$
M=\sum_{x,y}w(x,y)\left[\begin{matrix}{}I_x^2 & I_xI_y\\I_xI_y & I^2_y\end{matrix}\right]
$$
$I_xI_y$都表示梯度分量。以$I_x-I_y$为轴作平面直角坐标系，x、y导数的分布可以用主分量椭圆的形状和大小来表征。因为M是对称的，所以可以写成：
$$
M=R^{-1}\left[\begin{matrix}{}\lambda_1 & 0\\0 & \lambda_2\end{matrix}\right]R
$$
我们可以把M看作一个椭圆，其轴的长度由特征值决定，方向由R决定。

利用M的特征值进行图像点分类：

- $\lambda_1$和$\lambda_2$都很小，说明是平面区域
- 一个远大于两一个，说明是边
- 二者都很大，说明是角

角落相应测量：
$$
R=\det M-k(trace M)^2\\
\det M=\lambda_1\lambda_2\\
trace M=\lambda_1+\lambda_2
$$
其中k是经验确定的常数，取0.04~0.06。。R只取决于M的特征值。对于角来说R很大，对于一条边，R是负的且绝对值很大。对于平坦区域，R的绝对值很小。

-------

## 五、 特征描述

哈里斯检测器可以处理不变和协变的特征，但进行放缩的时候既不是不变的又不是协变的

### 5.1 尺度不变区域检测

在区域(圆)上设计一个函数，它是尺度不变的，即：即使它们在不同的尺度上，对应的区域也相同。例如:平均强度，对于相应的区域(即使是不同大小的区域)也是一样的。对于一个图像中的一点，我们可以把它看作是区域大小(圆半径)的函数。观察:达到最大值的区域大小应与图像尺度协变。

找到该函数的局部最大值，然后观察。函数达到最大值时的区域大小应该与图像比例成协变关系。这个比例不变的区域大小在每个图像中都是独立的。

#### 5.1.1 自动尺度检测

对于两张内容相同但尺度大小不同的图片，找到某个点后，取一个小区域计算上述的函数值，然后再把区域稍微放大，再算函数值，再放大......如此一来，使用不同大小的区域可以得到一系列的函数值结果。找到两张图片各自函数取最大值时的区域大小，区域大小之比就是图像尺度比，两个区域的内容基本相同。

#### 5.1.2 DoG（高斯函数差分） 检测器

我们可以使用高斯金字塔的固定窗口大小来实现，而不是计算越来越大的窗口。我们希望上述的函数有一个明显的、单个的最大值点。对于普通图像来说，一个好的函数应该是对对比度(局部强度的急剧变化)做出明显反应的函数。

定义检测尺度的函数为：
$$
f=Kernel*Image
$$
拉普拉斯核为：
$$
L=\sigma^2(G_{xx}(x,y,\sigma)+G_{yy}(x,y,\sigma))
$$
则高斯差分为：
$$
DoG=G(x,y,k\sigma)-G(x,y,\sigma)
$$
其中，
$$
G(x,y,\sigma)=\frac1{\sqrt{2\pi}\sigma}\exp(-\frac{x^2+y^2}{2\sigma^2})
$$
对于哈里斯-拉普拉斯检测器，找的最大值为哈里斯角探测器和拉普拉斯尺度的最大值，而DoG找的局部最大值为空间和尺度中的高斯差分。

高斯核在不同的内核大小分辨率（$\sigma$）下，我们可以看到不同的图像细节。换句话说，我们可以在不同的尺度上捕捉关键点。

### 5.2 SIFT图像区域检测器

目的在不同图像（可能含有部分相同内容）找到匹配点。一个基本的思想是对每个点赋予一个描述符，两张图片描述符相近的点匹配。描述符必须不变，即便图像改变了（如旋转、放缩、亮度改变等）。同时描述符还应该足以区分不同的点。

考虑找到关键点的一个特征方向，由此使得它变为旋转不变的。

使用与关键点比例相关的模糊图像（即取关键点周围的一小块区域并进行缩小，使用DoG模糊），计算关键点邻域的图像梯度。通过关键点的特征方向旋转梯度方向和位置。邻域的梯度方向不用最终算出一个结果，可以是邻域内每个点对八个方向进行加权。即：

1. 在特征点附近取16*16的区域
2. 对每个像素计算边方向
3. 剔除弱边缘
4. 对每个剩余的边缘创建方向（角度大小）的直方图
5. 将16\*16的区域分成16个4\*4的
6. 每个小区域单独计算方向的直方图。每个小区域16个像素，每个区域有8个方向，共128个方向描述符。因此SIFT是一个128维的向量，具有旋转和缩放不变性。比较每个向量就能进行匹配。

### 5.3 应用：全景技术

-----------

## 六、 图像缩放

### 6.1 背景

不同的设备有不同的分辨率，缩放的时候我们希望图像不是单纯的全部按比例变大或变小，而是可以自适应地去掉图像中不那么重要的部分，保留重要的部分，通过删去不重要的部分来实现变小。

### 6.2 图像重定向 

所谓的重定向就是给出输入图片与大小，输出图片的大小改变，但输出图片能很好地表现原图片的信息。没有客观的“很好地表现”的定义和测量方法，但总的来说，我们希望图像：

- 保留几何约束，如长宽比
- 保留重要的结构和内容
- 满足针对具体场景的限制条件

我们有梯度图：
$$
W=\sqrt{(\frac{\part}{\part x}I)^2+(\frac{\part}{\part y}I)^2}
$$
然后再定义一个saliency map（SM）将图像映射到0到1，二者的乘积称为重要性图。

定义一个能量函数$E(I)$，通过某些操作来改变图像$I$，从而得到SM。

### 6.3 Seam Carving接缝裁剪算法

基本思想：移除图像中不重要的像素，也就是能量更少的像素。能量高一般来说有较强的轮廓。人类的视觉对边缘更敏感，所以试着从平滑的区域移除内容。则可以使用能量函数：
$$
E_1(I)=|\frac\part{\part x}I|+|\frac\part{\part y}I|
$$
考虑每次移除能量最低的像素，但这样效果很不好。图像需要保证方正，因此考虑每次移除每一行中能量最低的像素。而且这些像素必须相邻才不会破坏图像内容。看上去，每次移除的一组像素就是从图像顶上到底下的一条曲线。

这样一来，删除的应该是能量最低的一条曲线，可以用动态规划计算：
$$
M(i,j)=E(i,j)+\min(M(i-1,j-1),M(i-1,j),M(i-1,j+1))
$$
其中M为累计能量，E为单个像素的能量。

### 6.4 动态规划

对于某些图像，采用上述方法会产生断层。考虑不移除能量最少的接缝，而是移除插入能量最少的接缝。也就是说，方程改为：

对于左侧接缝：
$$
C_L(i,j)=|I(i,j+1)-I(i,j-1)|+|I(i-1,j)-I(i,j-1)|
$$
对于右侧：
$$
C_R(i,j)=|I(i,j+1)-I(i,j-1)|+|I(i-1,j)-I(i,j+1)|
$$
对于竖直接缝：
$$
C_V(i,j)=|I(i,j+1)-I(i,j-1)|
$$
换句话说，就是去掉接缝后，希望接缝两端像素的差值最小。

每个像素的能量累计值就是上一个像素的累计值加上上面的方程的C的最小的一个。即：
$$
M(i,j)=\min\left\{\begin{matrix}{}
M(i-1,j-1)+|I(i,j+1)-I(i,j-1)|+|I(i-1,j)-I(i,j-1)|\\
M(i-1,j)+|I(i,j+1)-I(i,j-1)|\\
M(i-1,j+1)+|I(i,j+1)-I(i,j-1)|+|I(i-1,j)-I(i,j+1)|
\end{matrix}\right.
$$
可以拓展到更高维度。

### 6.5 应用

图像扩张(合成)、组合插入和移除、移除特定物体

------

## 七、 分段

### 7.1 分段和集群

目标：将图片内容划分划分成不同的像素集群，使得：

- 每个集群内的像素有关联
- 将类似的像素共同处理以便增加效率

一种分段的方法是集群，将图片过分段成许多小段，将相似的段进行聚合。

集群的主要方法有：

- 烧结集群：将每个点作为自己的集群开始，并迭代地合并最近的集群
- K-平均：迭代地重新分配点到最近的聚类中心
- 平均移动集群：估算概率分布函数的模式

### 7.2 知觉分组的格式塔理论

格式塔gestalt学派认为，集群的关键是视觉直觉。物体的组合关系产生了物体本身不具有的属性，也就是整体的信息大于各个部分的加和。

### 7.3 烧结的集群

集群可以看作是无监督学习，给定一组特征向量，对它们进行集群划分。通常用欧氏距离和余弦相似性作为距离，通过距离大小区分各个样本的关系远近。欧式距离为各个特征的平方和开根，余弦相似性为两个向量的内积再除以两个向量的长度积得到的商（即夹角余弦值）。

烧结集群：

1. 将每个点看做一个单独的集群
2. 找到两个相互最相似的集群
3. 合并
4. 重复

其中，集群显示度，或者说距离，可以按照需求定义，可以是平均点距离（对噪音鲁棒）、所有可能距离中最大/小距离（分别称为最近/远邻聚类，前者易产生瘦长的集群，后者易产生紧密的集群）、中位数等，算法通过最小集群数量或者集群间的最小距离阈值终止。

该方法易于实现且适用性广，但可能产生不平衡的集群，且运行时时间较长，容易陷入局部最优。

### 7.4 过分段

基于图的聚类图像分割。问题形式化：假设有无向图$G=(V,E)$，每条边有权重$w(v_i,v_j)$表示距离，$S$是原图的子图，有：$S=G'=(V,E')\quad E'\sub E$，且将$G$分到成了不同的集群。使用谓词$D$决定是否存在分段边界，也就是说，使用$D$作为标准判断不同集群的相似性，如果两个集群的集群间相似性小于集群内的相似性，则进行合并：
$$
Merge(C_1,C_2)=\left\{\begin{matrix}
True,dif(C_1,C_2)<in(C_1,C_2)\\
False,otherwise
\end{matrix}\right.\\
dif(C_1,C_2)=\min_{v_i\in C_1,v_j\in C_2,(C_1,C_2)\in E}w(v_i,v_j)\\
in(C_1,C_2)=\min_{C\in\{C_1,C_2\}}[\max_{v_i,v_j\in C}[w(v_i,v_j)+\frac k{|C|}]]
$$
也就是说，如果两个集群中点的距离的最小值小于两个集群内的点的距离最大值更小的那一个则进行合并。其中$k/|C|$设置了内部节点的差异性。如果$k$较大，则集群规模往往更大，否则更小。

对于一张图像，我们可以将每个像素投影到特征空间$(x,y,r,g,b)$上，也就是坐标和颜色通道组成的特征空间。每个像素在八领域内与八个像素相邻，即具有边。边的距离由特征向量计算得出，一般用欧氏距离。为了让具有$n$个像素的图片的运行时间为$O(n\log n)$，每次只选择最近的十个邻居的边。

-------

## 十二、 词袋

### 12.1 BoW（Visual bag of words）词袋介绍

纹理泛指物体面上的花纹或线条，是物体上呈现的线形纹路，纹理的特点是基本元素或文本的重复。其中的基本元素被称为纹理基元texton。纹路可能由多个不同的纹理基元组成，我们可以依据纹理基元的个数画出其直方图，被称为通用纹理基元字典。

将字典中的单词与对应的频率无序地用文档表示出来，就是词袋。如句子“你好”的词袋为：”你“，频率为1，”好“频率为1，其内部是无序的。对于图片来说，将图片拆分成许多小片段，每个片段就是字典中的一个内容。由词袋的特征可以进行各种操作和分析。当出现新图片时，可以建立该图片的特征直方图，然后在已知字典中寻找最相近的词。

### 12.2 空间金字塔匹配

### 12.3 朴素贝叶斯

